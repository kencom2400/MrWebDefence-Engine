name: Test Log Forwarding

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'docker/fluentd/**'
      - 'docker/nginx/**'
      - 'docker/openappsec/**'
      - 'docker/docker-compose.yml'
      - 'scripts/openappsec/test-log-forwarding.sh'
      - '.github/workflows/test-log-forwarding.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'docker/fluentd/**'
      - 'docker/nginx/**'
      - 'docker/openappsec/**'
      - 'docker/docker-compose.yml'
      - 'scripts/openappsec/test-log-forwarding.sh'
      - '.github/workflows/test-log-forwarding.yml'
  workflow_dispatch:

jobs:
  test-log-forwarding:
    name: Test Log Forwarding
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          jq --version
          curl --version

      - name: Create required directories
        run: |
          mkdir -p docker/nginx/logs
          mkdir -p docker/openappsec/logs
          mkdir -p docker/fluentd/log
          # FQDN別のログディレクトリを作成（Nginx設定ファイル生成前に必要）
          mkdir -p docker/nginx/logs/test.example.com
          mkdir -p docker/nginx/logs/example1.com
          mkdir -p docker/nginx/logs/example2.com
          mkdir -p docker/nginx/logs/example3.com

      - name: Build Fluentd image
        working-directory: docker
        run: |
          docker build --no-cache -t docker-fluentd ./fluentd

      - name: Start services
        working-directory: docker
        run: |
          echo "Starting services..."
          if ! docker-compose up -d nginx openappsec-agent fluentd 2>&1 | tee /tmp/docker-compose-startup.log; then
            echo "❌ Failed to start services"
            echo "=== Docker Compose Output ==="
            cat /tmp/docker-compose-startup.log || true
            echo ""
            echo "=== Container Status ==="
            docker-compose ps || true
            echo ""
            echo "=== Recent Logs ==="
            docker-compose logs --tail=50 || true
            exit 1
          fi
          echo "✅ Services started successfully"
          echo "Waiting for services to be ready..."

      - name: Wait for services to be healthy
        working-directory: docker
        run: |
          echo "Checking service health..."
          MAX_RETRIES=30
          RETRY_COUNT=0
          
          # Wait for Nginx to be ready
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -s -f -m 5 -H "Host: test.example.com" http://localhost/health > /dev/null 2>&1; then
              echo "✅ Nginx is ready"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $((RETRY_COUNT % 5)) -eq 0 ]; then
              echo "  Waiting for Nginx... (${RETRY_COUNT}/${MAX_RETRIES})"
              docker-compose ps
            fi
            sleep 2
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "❌ Nginx failed to start (timeout)"
            docker-compose ps
            docker-compose logs --tail=50 nginx
            exit 1
          fi
          
          # Wait a bit more for OpenAppSec Agent and Fluentd
          echo "Waiting for OpenAppSec Agent and Fluentd to be ready..."
          sleep 5

      - name: Check service status
        working-directory: docker
        run: |
          docker-compose ps
          echo ""
          echo "Service logs:"
          docker-compose logs --tail=20

      - name: Run log forwarding test
        working-directory: docker
        run: |
          chmod +x ../scripts/openappsec/test-log-forwarding.sh
          ../scripts/openappsec/test-log-forwarding.sh
        continue-on-error: false

      - name: Collect logs on failure
        if: failure()
        working-directory: docker
        run: |
          echo "=== Service Status ==="
          docker-compose ps
          echo ""
          echo "=== Fluentd Logs ==="
          docker-compose logs fluentd || true
          echo ""
          echo "=== Nginx Logs ==="
          docker-compose logs nginx || true
          echo ""
          echo "=== OpenAppSec Agent Logs ==="
          docker-compose logs openappsec-agent || true

      - name: Cleanup
        if: always()
        working-directory: docker
        run: |
          docker-compose down -v || true

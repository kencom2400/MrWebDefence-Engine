# Epic 5: WAFエンジン基盤実装 タスクレビュー

## 概要

設計書（MWD-38-openappsec-integration.md）をベースに、Epic 5の子タスクの過不足を確認します。

## 現在の子タスク一覧

- **Task 5.1**: OpenAppSec統合
- **Task 5.2**: 設定取得・動的更新機能実装
- **Task 5.3**: ログ転送機能実装
- **Task 5.4**: RateLimit機能実装
- **Task 5.5**: GeoIP機能実装
- **Task 5.6**: ヘルスチェック機能実装

## 過不足分析

### ❌ 不足しているタスク

#### 1. Docker Compose構成の実装
**理由**: 設計書には`docker/docker-compose.yml`の詳細な構成が記載されているが、タスクに明記されていない

**推奨タスク**:
- **Task 5.0（新規）**: Docker Compose構成実装
  - `docker/docker-compose.yml`の作成
  - Nginx、OpenAppSec Agent、設定取得エージェントのコンテナ定義
  - 共有メモリボリュームの設定
  - ネットワーク設定
  - 環境変数の設定

#### 2. Nginx設定ファイルの自動生成（FQDN別）
**理由**: Task 5.2には「OpenAppSec設定ファイル生成機能実装」は含まれているが、「Nginx設定ファイル生成機能実装」が明記されていない

**推奨対応**:
- **Task 5.2に追加**: Nginx設定ファイル生成機能実装（FQDN別）
  - `nginx/conf.d/{fqdn}.conf`の自動生成
  - 無効化されたFQDNの設定ファイル削除
  - バックエンド設定（proxy_pass）の自動生成

#### 3. 複数FQDN対応の実装
**理由**: 設計書では「1つのNginxで複数のFQDNを扱う」ことが主要要件だが、タスクに明記されていない

**推奨対応**:
- **Task 5.1に追加**: 複数FQDN対応の実装
  - Nginxのバーチャルホスト設定（複数FQDN対応）
  - OpenAppSecのspecificRulesによるFQDN別設定
  - FQDN別のログ出力設定

#### 4. インストールスクリプトの実装
**理由**: 設計書には`scripts/openappsec/install.sh`が詳細に記載されているが、タスクに明記されていない

**推奨タスク**:
- **Task 5.7（新規）**: インストール・セットアップスクリプト実装
  - `scripts/openappsec/install.sh`の実装
  - 依存関係の確認（Docker、docker-compose）
  - 設定ファイルの検証
  - Docker Composeでのサービス起動

#### 5. 設定取得エージェントの起動スクリプト
**理由**: 設計書には`scripts/openappsec/start-config-agent.sh`が記載されているが、タスクに明記されていない

**推奨対応**:
- **Task 5.2に追加**: 設定取得エージェント起動スクリプト実装
  - `scripts/openappsec/start-config-agent.sh`の実装
  - 環境変数の設定確認
  - エージェントの起動・停止

#### 6. 設定取得エージェントのヘルスチェック
**理由**: Task 5.6のヘルスチェックには設定取得エージェントのチェックが含まれていない

**推奨対応**:
- **Task 5.6に追加**: 設定取得エージェントのヘルスチェック
  - 設定取得エージェントの状態確認
  - 設定取得エージェントのログ確認
  - 設定ファイルの存在確認

### ⚠️ タスク内容の不足・不明確な点

#### 1. Task 5.1: OpenAppSec統合
**現状**: 
- OpenAppSecのインストール・設定
- Nginxとの統合（共有メモリ使用）
- OpenAppSec設定ファイルの動的更新機能実装
- 設定のバージョン管理機能実装

**不足点**:
- **複数FQDN対応**: Nginxのバーチャルホスト設定（複数FQDN対応）が明記されていない
- **Attachment Moduleの設定**: NginxにAttachment Moduleを読み込む設定が明記されていない
- **共有メモリの設定**: 共有メモリゾーンの設定方法が明記されていない

**推奨追加**:
- Nginx Attachment Moduleの読み込み設定
- 共有メモリゾーンの設定（`openappsec_shared_memory_zone`）
- 複数FQDN対応のバーチャルホスト設定

#### 2. Task 5.2: 設定取得・動的更新機能実装
**現状**:
- 管理APIから設定取得機能実装（ポーリング、デフォルト5分間隔）
- OpenAppSec設定ファイル生成機能実装
- 設定ファイルリロード機能実装（再起動不要）
- 設定のローカルキャッシュ機能実装（TTL: 5分）

**不足点**:
- **Nginx設定ファイル生成**: Nginx設定ファイル（`conf.d/{fqdn}.conf`）の生成が明記されていない
- **設定ファイル削除**: 無効化されたFQDNの設定ファイル削除が明記されていない
- **エラーハンドリング**: API呼び出し失敗時のリトライロジックが明記されていない

**推奨追加**:
- Nginx設定ファイル生成機能実装（FQDN別）
- 無効化されたFQDNの設定ファイル削除機能
- API呼び出し失敗時のリトライロジック（指数バックオフ）

#### 3. Task 5.6: ヘルスチェック機能実装
**現状**:
- ヘルスチェックエンドポイント実装（GET /engine/v1/health）
- Nginx状態チェック機能実装
- OpenAppSec状態チェック機能実装
- Redis接続チェック機能実装
- ヘルスチェックレスポンス実装（JSON形式）

**不足点**:
- **設定取得エージェントのチェック**: 設定取得エージェントの状態確認が含まれていない
- **設定ファイルの確認**: 生成された設定ファイルの存在確認が含まれていない
- **ヘルスチェックスクリプト**: `scripts/openappsec/health-check.sh`の実装が明記されていない

**推奨追加**:
- 設定取得エージェントの状態チェック機能実装
- 設定ファイルの存在確認機能実装
- ヘルスチェックスクリプト実装（`scripts/openappsec/health-check.sh`）

### ✅ 適切にカバーされているタスク

- **Task 5.3**: ログ転送機能実装 - 設計書の内容と一致
- **Task 5.4**: RateLimit機能実装 - 設計書の内容と一致
- **Task 5.5**: GeoIP機能実装 - 設計書の内容と一致

## 推奨されるタスク修正・追加

### 新規タスクの追加

#### Task 5.0: Docker Compose構成実装（新規）
**リポジトリ**: MrWebDefence-Engine

**なぜやるか**
OpenAppSec、Nginx、設定取得エージェントを統合して動作させるためのDocker Compose構成が必要。

**何をやるか（概要）**
- `docker/docker-compose.yml`の作成
- Nginxコンテナの定義（Attachment Module読み込み）
- OpenAppSec Agentコンテナの定義
- 設定取得エージェントコンテナの定義
- 共有メモリボリュームの設定
- ネットワーク設定
- 環境変数の設定

**受け入れ条件**
- [ ] Docker Composeで全コンテナが正常に起動する
- [ ] 共有メモリボリュームが正常にマウントされる
- [ ] コンテナ間の通信が正常に動作する
- [ ] 環境変数が正しく設定される

#### Task 5.7: インストール・セットアップスクリプト実装（新規）
**リポジトリ**: MrWebDefence-Engine

**なぜやるか**
開発者が簡単にOpenAppSec環境をセットアップできるようにする必要がある。

**何をやるか（概要）**
- `scripts/openappsec/install.sh`の実装
- 依存関係の確認（Docker、docker-compose）
- 設定ファイルの検証
- Docker Composeでのサービス起動
- 初期設定のガイダンス

**受け入れ条件**
- [ ] インストールスクリプトが正常に動作する
- [ ] 依存関係の確認が正常に動作する
- [ ] 設定ファイルの検証が正常に動作する
- [ ] Docker Composeでサービスが正常に起動する

### 既存タスクの修正

#### Task 5.1: OpenAppSec統合（修正）

**追加すべき内容**:
- Nginx Attachment Moduleの読み込み設定
- 共有メモリゾーンの設定（`openappsec_shared_memory_zone`）
- 複数FQDN対応のバーチャルホスト設定
- `docker/nginx/nginx.conf`の作成

**修正後の「何をやるか（概要）」**:
- OpenAppSecのインストール・設定
- Nginxとの統合（共有メモリ使用）
- Nginx Attachment Moduleの読み込み設定
- 共有メモリゾーンの設定
- 複数FQDN対応のバーチャルホスト設定
- OpenAppSec設定ファイルの動的更新機能実装
- 設定のバージョン管理機能実装

#### Task 5.2: 設定取得・動的更新機能実装（修正）

**追加すべき内容**:
- Nginx設定ファイル生成機能実装（FQDN別）
- 無効化されたFQDNの設定ファイル削除機能
- API呼び出し失敗時のリトライロジック（指数バックオフ）
- 設定取得エージェント起動スクリプト実装

**修正後の「何をやるか（概要）」**:
- 管理APIから設定取得機能実装（ポーリング、デフォルト5分間隔）
- OpenAppSec設定ファイル生成機能実装
- **Nginx設定ファイル生成機能実装（FQDN別）**
- **無効化されたFQDNの設定ファイル削除機能**
- 設定ファイルリロード機能実装（再起動不要）
- 設定のローカルキャッシュ機能実装（TTL: 5分）
- **API呼び出し失敗時のリトライロジック（指数バックオフ）**
- **設定取得エージェント起動スクリプト実装**

#### Task 5.6: ヘルスチェック機能実装（修正）

**追加すべき内容**:
- 設定取得エージェントの状態チェック機能実装
- 設定ファイルの存在確認機能実装
- ヘルスチェックスクリプト実装

**修正後の「何をやるか（概要）」**:
- ヘルスチェックエンドポイント実装（GET /engine/v1/health）
- Nginx状態チェック機能実装
- OpenAppSec状態チェック機能実装
- **設定取得エージェントの状態チェック機能実装**
- Redis接続チェック機能実装
- **設定ファイルの存在確認機能実装**
- ヘルスチェックレスポンス実装（JSON形式）
- **ヘルスチェックスクリプト実装（`scripts/openappsec/health-check.sh`）**

## まとめ

### 新規タスク追加が必要
1. **Task 5.0**: Docker Compose構成実装
2. **Task 5.7**: インストール・セットアップスクリプト実装

### 既存タスクの修正が必要
1. **Task 5.1**: 複数FQDN対応、Attachment Module設定、共有メモリ設定を追加
2. **Task 5.2**: Nginx設定ファイル生成、設定ファイル削除、リトライロジック、起動スクリプトを追加
3. **Task 5.6**: 設定取得エージェントのチェック、設定ファイル確認、ヘルスチェックスクリプトを追加

### ❌ 重大な不足: 管理API（`GET /engine/v1/config`）の実装タスク

**問題**: WAFエンジン向けの設定配信API（`GET /engine/v1/config`）の実装がどのタスクにも含まれていない

**現状**:
- 設計書（DESIGN.md）には「設定管理API: WAFエンジン向けの設定配信API」として定義されている
- `GET /engine/v1/config`エンドポイントの仕様は設計書に記載されている
- しかし、EPIC_TASK_DESIGN.mdには実装タスクが存在しない

**影響**:
- Task 5.2（設定取得・動的更新機能実装）が「管理APIから設定取得」を前提としているが、そのAPI自体の実装タスクがない
- 設定取得エージェントが動作するためには、このAPIが必須

**推奨対応**:
- **Epic 4に新規タスクを追加**: Task 4.6: WAFエンジン向け設定配信API実装
  - **リポジトリ**: MrWebDefence-Console
  - **なぜやるか**: WAFエンジン（設定取得エージェント）が設定を取得するためのAPIが必要
  - **何をやるか（概要）**:
    - `GET /engine/v1/config`エンドポイント実装
    - APIトークン認証実装
    - データベースからFQDN設定取得
    - データベースからシグニチャグループ設定取得
    - OpenAppSec設定形式への変換ロジック実装
    - 設定のバージョン管理（バージョン番号の生成）
    - レスポンス形式（JSON）の実装
  - **受け入れ条件**:
    - [ ] `GET /engine/v1/config`エンドポイントが正常に動作する
    - [ ] APIトークン認証が正常に動作する
    - [ ] FQDN設定が正しく取得される
    - [ ] シグニチャグループ設定が正しく取得される
    - [ ] OpenAppSec設定形式への変換が正常に動作する
    - [ ] バージョン番号が正しく生成される
    - [ ] レスポンスが設計書の仕様通りに返却される

**または、既存タスクに追加**:
- **Task 4.4に追加**: WAFエンジン向け設定配信API実装
  - 「FQDN管理機能実装」の一部として、WAFエンジンへの設定配信APIも実装

### ✅ 適切にカバーされているタスク
- Task 5.3: ログ転送機能実装
- Task 5.4: RateLimit機能実装
- Task 5.5: GeoIP機能実装

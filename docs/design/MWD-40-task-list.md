# Task 5.3: ログ転送機能実装 作業タスクリスト

## 概要

ログ連携方法の比較検討を先に実施し、その結果に基づいてFluentd永続ボリュームの必要性を判断する前提で、作業タスクリストを作成しました。

## 作業フェーズ

### Phase 0: ログ連携方法の比較検討（最優先）

このフェーズの結果に基づいて、Phase 1以降の実装方針を決定します。

#### タスク 0-1: 現状把握と要件整理

- [ ] **現行ログ出力方式の調査**
  - Nginxのログ出力先と形式を確認
    - アクセスログ: `/var/log/nginx/access.log`, `/var/log/nginx/{fqdn}.access.log`
    - エラーログ: `/var/log/nginx/error.log`, `/var/log/nginx/{fqdn}.error.log`
  - OpenAppSec Agentのログ出力先と形式を確認
    - ログパス: `/var/log/nano_agent/*.log`
    - ログ形式: JSON形式（設定可能）
  - 現在のDocker Compose設定を確認
    - 全サービスで`logging: driver: "json-file"`が設定されている
    - ログファイルの保存場所とローテーション設定

- [ ] **ログ転送要件の整理**
  - 転送先: ログ管理サーバ（Elasticsearch/Splunk/CloudWatch等）
  - 転送形式: JSON形式
  - 転送頻度: リアルタイムまたはバッチ
  - 信頼性要件: ログ損失の許容度、重複の許容度
  - パフォーマンス要件: 転送遅延、スループット
  - セキュリティ要件: 暗号化、アクセス制御
  - 運用要件: 監視、アラート、トラブルシューティング

#### タスク 0-2: 共有ボリューム方式の調査

- [ ] **共有ボリューム方式の技術調査**
  - アーキテクチャ
    - 各コンテナ（Nginx、OpenAppSec Agent）がログファイルを共有ボリュームに出力
    - Fluentdコンテナが共有ボリュームからログファイルを読み取り
    - Fluentdがログ管理サーバに転送
  - 利点
    - ログファイルへの直接アクセスが可能
    - ログローテーションに対応しやすい
    - 既存のログファイル形式をそのまま利用可能
    - デバッグ時にログファイルを直接確認できる
    - 複数のFQDNログを個別に処理可能
  - 欠点
    - ボリューム管理が必要
    - ディスク容量の管理が必要
    - ログファイルのパーミッション管理が必要
    - コンテナ間の依存関係が増える
  - 実装方法
    - Docker Composeで共有ボリュームを定義
    - Nginx、OpenAppSec Agentのログ出力先を共有ボリュームに設定
    - Fluentdの`tail`プラグインでログファイルを監視
    - `pos_file`で読み取り位置を管理（永続ボリュームが必要）

- [ ] **共有ボリューム方式のパフォーマンス検討**
  - ログファイルのI/Oパフォーマンス
  - 大量のログファイルを処理する場合の影響
  - ディスク容量の見積もり

- [ ] **共有ボリューム方式の信頼性検討**
  - コンテナ再起動時の挙動
  - ログファイルのローテーション時の挙動
  - `pos_file`の永続化の必要性
  - バッファリングの必要性

#### タスク 0-3: ログドライバ方式の調査

- [ ] **ログドライバ方式の技術調査**
  - アーキテクチャ
    - Dockerのログドライバ（`fluentd`、`gelf`、`syslog`等）を使用
    - 各コンテナの標準出力/標準エラー出力をログドライバが収集
    - ログドライバが直接Fluentdに転送
  - 利点
    - Docker標準機能を利用
    - ボリューム管理が不要
    - ログファイルの管理が不要
    - コンテナ間の依存関係が少ない
    - Kubernetes等のコンテナオーケストレーション環境に移行しやすい
  - 欠点
    - 標準出力/標準エラー出力のみが対象
    - ログファイルへの直接アクセスが困難
    - 複数のログファイル（FQDN別）を個別に処理するのが困難
    - ログローテーションの制御が難しい
    - 既存のログファイル形式を変更する必要がある可能性
  - 実装方法
    - Docker Composeで`logging: driver: "fluentd"`を設定
    - Fluentdの`forward`プラグインでログを受信
    - タグ付けはDockerのログドライバオプションで設定

- [ ] **ログドライバ方式のパフォーマンス検討**
  - 標準出力へのI/Oパフォーマンス
  - 大量のログを処理する場合の影響
  - ネットワーク転送のオーバーヘッド

- [ ] **ログドライバ方式の信頼性検討**
  - コンテナ再起動時の挙動
  - ログドライバの障害時の挙動
  - バッファリングの仕組み

#### タスク 0-4: ハイブリッド方式の検討

- [ ] **ハイブリッド方式の検討**
  - 共有ボリューム + ログドライバの併用
  - 用途別の使い分け
    - アクセスログ: 共有ボリューム（FQDN別処理のため）
    - エラーログ: ログドライバ（簡易性のため）
    - OpenAppSecログ: 共有ボリューム（構造化ログのため）

#### タスク 0-5: 比較表の作成と評価

- [ ] **比較表の作成**
  - 共有ボリューム方式 vs ログドライバ方式の比較表
  - 評価項目:
    - 実装の複雑さ
    - 運用の容易さ
    - パフォーマンス
    - 信頼性
    - スケーラビリティ
    - セキュリティ
    - 将来の拡張性（Kubernetes等への移行）
    - コスト（リソース使用量）

- [ ] **推奨方式の決定**
  - 比較結果に基づいて推奨方式を決定
  - 採用理由を明確化
  - 設計書に比較検討セクションを追加

#### タスク 0-6: Fluentd永続ボリュームの必要性判断

- [ ] **Fluentd永続ボリュームの必要性判断**
  - 共有ボリューム方式を採用する場合:
    - `pos_file`の永続化が必要 → 永続ボリュームが必要
    - バッファリングの永続化が必要 → 永続ボリュームが必要
  - ログドライバ方式を採用する場合:
    - `pos_file`が不要 → 永続ボリュームは不要（または最小限）
    - バッファリングの永続化は検討が必要
  - 判断結果を設計書に反映

### Phase 1: 設計書の更新（比較検討結果の反映）

- [ ] **設計書への比較検討結果の追加**
  - ログ連携方法の比較検討セクションを追加
  - 比較表を追加
  - 採用方式とその理由を明記
  - Fluentd永続ボリュームの必要性を明記

### Phase 2: Critical対応（比較検討結果に基づく）

- [ ] **1. Fluentd永続ボリュームの追加（必要に応じて）**
  - 比較検討結果に基づいて、必要であれば実装
  - `docker-compose.yml`に`fluentd`サービスの永続ボリュームを追加
  - `./fluentd/log:/var/log/fluentd`をマウント
  - 設計書のDocker Compose設定例を更新

### Phase 3: Medium対応（推奨）

- [ ] **2. シンタックスハイライトの修正**
  - Fluentd設定ファイルのコードブロックを`xml`から`aconf`に変更

- [ ] **3. Nginxエラーログパーサーの修正**
  - `<parse> @type nginx`を`<parse> @type none`に変更
  - 理由を設計書に追記

- [ ] **4. Fluentd設定の重複排除**
  - `<match nginx.**>`と`<match openappsec.**>`を`<match {nginx,openappsec}.**>`に統合

### Phase 4: 設計検討・拡張（要検討）

- [ ] **6. Fluentd設定ファイルのディレクトリ構成**
  - 処理別ディレクトリ構成を設計書に追加
  - 各ディレクトリの役割を説明
  - 設定ファイルの分割例を追加

- [ ] **7. 複数FQDNへのログ対応**
  - FQDN別の`pos_file`設定例を追加（共有ボリューム方式の場合）
  - FQDN別の`tag`設定例を追加
  - 動的設定生成の方法を検討

- [ ] **8. Nginxアクセスログのタグ設計**
  - タグ設計セクションを追加
  - ホスト名、顧客名、FQDN名、日時の抽出方法を記載
  - `record_transformer`プラグインの設定例を追加

- [ ] **9. OpenAppSecログのタグ設計**
  - タグ設計セクションを追加
  - ホスト名、顧客名、FQDN名、日時、検知シグニチャの抽出方法を記載
  - `record_transformer`プラグインの設定例を追加

## 実装優先順位

### 最優先（Phase 0: 比較検討）

1. **ログ連携方法の比較検討**（必須）
   - 現状把握と要件整理
   - 共有ボリューム方式の調査
   - ログドライバ方式の調査
   - ハイブリッド方式の検討
   - 比較表の作成と評価
   - Fluentd永続ボリュームの必要性判断

### 高優先度（Phase 1-2: 設計書更新とCritical対応）

2. **設計書への比較検討結果の追加**（必須）
3. **Fluentd永続ボリュームの追加**（比較検討結果に基づいて判断）

### 中優先度（Phase 3: Medium対応）

4. Nginxエラーログパーサーの修正
5. Fluentd設定の重複排除
6. シンタックスハイライトの修正

### 低優先度（Phase 4: 設計検討・拡張）

7. Fluentd設定ファイルのディレクトリ構成
8. 複数FQDNへのログ対応
9. Nginxアクセスログのタグ設計
10. OpenAppSecログのタグ設計

## 成果物

### Phase 0の成果物

- ログ連携方法の比較検討ドキュメント
  - 現状把握レポート
  - 共有ボリューム方式の技術調査レポート
  - ログドライバ方式の技術調査レポート
  - 比較表
  - 推奨方式とその理由
  - Fluentd永続ボリュームの必要性判断

### Phase 1以降の成果物

- 更新された実装設計書（`MWD-40-implementation-plan.md`）
- 実装コード（必要に応じて）

## 注意事項

- Phase 0の比較検討結果に基づいて、Phase 1以降の実装方針を決定する
- Fluentd永続ボリュームの必要性は、比較検討結果に基づいて判断する
- 複数FQDNへのログ対応は、採用する方式によって実装方法が異なる
- タグ設計は、採用する方式によって実装方法が異なる

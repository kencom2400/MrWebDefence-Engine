#!/bin/bash

# çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Phase 1-5.3ã®çµ±åˆå‹•ä½œç¢ºèª

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/../.." && pwd)"
DOCKER_DIR="${REPO_ROOT}/docker"

cd "$DOCKER_DIR"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  çµ±åˆãƒ†ã‚¹ãƒˆ: OpenAppSecçµ±åˆã®å‹•ä½œç¢ºèª"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# ãƒ†ã‚¹ãƒˆç”¨FQDNãƒªã‚¹ãƒˆ
FQDNS=("test.example.com" "example1.com" "example2.com" "example3.com")

# 1. å…¨ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ç¢ºèª
echo "ğŸ“‹ 1. å…¨ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ç¢ºèª"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker-compose ps
echo ""

# 2. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
echo "ğŸ“‹ 2. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
"${SCRIPT_DIR}/health-check.sh"
echo ""

# 3. å„FQDNã§ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ
echo "ğŸ“‹ 3. å„FQDNã§ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
for fqdn in "${FQDNS[@]}"; do
    echo "ãƒ†ã‚¹ãƒˆ: ${fqdn}"
    
    # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    if curl -s -H "Host: ${fqdn}" http://localhost/health > /dev/null; then
        echo "  âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: OK"
    else
        echo "  âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: å¤±æ•—"
    fi
    
    # é€šå¸¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    response=$(curl -s -w "\n%{http_code}" -H "Host: ${fqdn}" http://localhost/ 2>/dev/null || echo -e "\n000")
    http_code=$(echo "$response" | tail -n1)
    
    if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
        echo "  âœ… HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ: OK (HTTP $http_code)"
    else
        echo "  âš ï¸  HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ: HTTP $http_code"
    fi
done
echo ""

# 4. OpenAppSec Agentã®ãƒ­ã‚°ç¢ºèª
echo "ğŸ“‹ 4. OpenAppSec Agentã®ãƒ­ã‚°ç¢ºèªï¼ˆæœ€æ–°10è¡Œï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker-compose logs --tail=10 openappsec-agent | grep -i "transaction\|request\|host" || echo "  é–¢é€£ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
echo ""

# 5. Nginxãƒ­ã‚°ã®ç¢ºèª
echo "ğŸ“‹ 5. Nginxãƒ­ã‚°ã®ç¢ºèªï¼ˆæœ€æ–°10è¡Œï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker-compose logs --tail=10 nginx
echo ""

# 6. ConfigAgentã®çŠ¶æ…‹ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
echo "ğŸ“‹ 6. ConfigAgentã®çŠ¶æ…‹ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if docker-compose ps config-agent 2>/dev/null | grep -q "Up"; then
    echo "âœ… ConfigAgentãŒèµ·å‹•ã—ã¦ã„ã¾ã™"
    echo "   æœ€æ–°ã®ãƒ­ã‚°ï¼ˆ5è¡Œï¼‰:"
    docker-compose logs --tail=5 config-agent
else
    echo "â„¹ï¸  ConfigAgentã¯èµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
fi
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  âœ… çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
# 7. ãƒ­ã‚°è»¢é€æ©Ÿèƒ½ã®ç¢ºèªï¼ˆPhase 5.3ï¼‰
echo "ğŸ“‹ 7. ãƒ­ã‚°è»¢é€æ©Ÿèƒ½ã®ç¢ºèªï¼ˆPhase 5.3ï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if docker-compose ps fluentd 2>/dev/null | grep -q "Up"; then
    echo "âœ… FluentdãŒèµ·å‹•ã—ã¦ã„ã¾ã™"
    echo "   è©³ç´°ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
    echo "   ${SCRIPT_DIR}/test-log-forwarding.sh"
else
    echo "â„¹ï¸  Fluentdã¯èµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
fi
echo ""

echo "è©³ç´°ãªç¢ºèª:"
echo "  - Phase 1: ${SCRIPT_DIR}/test-phase1.sh"
echo "  - Phase 2: ${SCRIPT_DIR}/test-phase2.sh"
echo "  - Phase 3: ${SCRIPT_DIR}/test-phase3.sh"
echo "  - ãƒ­ã‚°è»¢é€æ©Ÿèƒ½: ${SCRIPT_DIR}/test-log-forwarding.sh"
echo "  - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: ${SCRIPT_DIR}/health-check.sh"

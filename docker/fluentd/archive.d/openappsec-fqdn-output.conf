# OpenAppSec FQDN別ログファイル出力設定
# Task 5.3: ログ転送機能実装
# OpenAppSecのログは元々FQDN別に出力されないため、FluentdでFQDN別に分離して出力

<label @archive_openappsec_fqdn>
  # OpenAppSecログをFQDN別のディレクトリに出力
  # 注意: OpenAppSecログのみを処理するため、タグパターンで明示的に指定
  
  # ステップ1: FQDNのドットをアンダースコアに置き換えたフィールドを追加
  # タグ形式: openappsec.detection.{hostname}.{customer_name}.{fqdn}.{signature}...
  # FQDNはタグの4番目の要素（インデックス3）だが、FQDNにドットが含まれる場合は分割される
  # そのため、レコードのfqdnフィールドを使用してFQDN別にタグを分ける
  # 注意: FQDNにドットが含まれる場合、タグで使用できないため、アンダースコアに置き換える
  <filter openappsec.detection.**>
    @type record_transformer
    enable_ruby true
    <record>
      # FQDNのドットをアンダースコアに置き換えたフィールドを追加
      # 例: test.example.com → test_example_com
      # 注意: fqdnフィールドが存在しない場合は"unknown"を使用
      fqdn_for_path ${(record["fqdn"] || "unknown").gsub(/\./, '_')}
    </record>
  </filter>
  
  # ステップ2: レコードのfqdn_for_pathフィールドを使用してFQDN別にタグを分ける
  <match openappsec.detection.**>
    @type rewrite_tag_filter
    <rule>
      key fqdn_for_path
      pattern /^(.+)$/
      tag openappsec.fqdn.${1}
    </rule>
  </match>
  
  # ステップ3: FQDN別のディレクトリに出力
  # タグ形式: openappsec.fqdn.{fqdn_with_underscore}
  # FQDNはタグの3番目の要素（インデックス2）
  # 注意: ディレクトリ名はアンダースコア区切りになるが、元のFQDN情報はレコードに保持される
  <match openappsec.fqdn.**>
    @type file
    # パス形式: /var/log/nano_agent/{fqdn_with_underscore}/*.log（設計書に準拠）
    # 例: /var/log/nano_agent/test_example_com/detection.20240115.log
    # 注意: 元のログファイル（/var/log/nano_agent/*.log）とは異なるディレクトリに出力することで、ログの無限ループを防止
    path /var/log/nano_agent/${tag_parts[2]}/detection
    # ファイル名の形式: detection.YYYYMMDD.log
    # time_slice_formatで日付を含める（YYYYMMDD形式）
    time_slice_format %Y%m%d
    # JSON形式で出力
    <format>
      @type json
    </format>
    <buffer tag,time>
      @type file
      path /var/log/fluentd/buffer/openappsec_fqdn
      timekey 1d
      timekey_wait 10m
      timekey_use_utc true
      flush_interval 5s
      flush_at_shutdown true
    </buffer>
  </match>
</label>

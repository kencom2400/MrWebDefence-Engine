# OpenAppSec FQDN別ログファイル出力設定
# Task 5.3: ログ転送機能実装
# OpenAppSecのログは元々FQDN別に出力されないため、FluentdでFQDN別に分離して出力

<label @archive_openappsec_fqdn>
  # OpenAppSecログをFQDN別のディレクトリに出力
  # 注意: OpenAppSecログのみを処理するため、タグパターンで明示的に指定
  
  # ステップ1: FQDNのドットをアンダースコアに置き換えたフィールドを追加
  # タグ形式: openappsec.detection（シンプルなタグ）
  # FQDN情報はレコードのfqdnフィールドに含まれている
  # 注意: FQDNにドットが含まれる場合、タグで使用できないため、アンダースコアに置き換える
  <filter openappsec.detection.**>
    @type record_transformer
    enable_ruby true
    <record>
      # FQDNのドットをアンダースコアに置き換えたフィールドを追加
      # 例: test.example.com → test_example_com
      # 注意: fqdnフィールドが存在しない場合は"unknown"を使用
      fqdn_for_path ${(record["fqdn"] || "unknown").gsub(/\./, '_')}
    </record>
  </filter>
  
  # ステップ2: レコードのfqdn_for_pathフィールドを使用してFQDN別にタグを変更
  # タグをFQDNのみに変更（fileプラグインのpathで${tag}を使用するため）
  <match openappsec.detection.**>
    @type rewrite_tag_filter
    <rule>
      key fqdn_for_path
      pattern /^(.+)$/
      tag ${1}
    </rule>
  </match>
  
  # ステップ3: パスはfileプラグインでタグから直接取得
  # タグ形式: {fqdn_with_underscore}（例: test_example_com）
  # 注意: ディレクトリ名はアンダースコア区切りになるが、元のFQDN情報はレコードに保持される
  
  # ステップ4: ファイルに出力
  <match **>
    @type file
    # パスはタグから取得（タグ形式: {fqdn_with_underscore}）
    # ${tag}がFQDN（アンダースコア区切り）を含む
    # 日付はtime_slice_formatで自動的に追加される
    path /var/log/nano_agent/${tag}/detection
    append true
    # ディレクトリを自動作成
    auto_create_dir true
    # 日付形式を追加（YYYYMMDD形式）
    time_slice_format %Y%m%d
    # JSON形式で出力
    <format>
      @type json
    </format>
    <buffer tag,time>
      @type file
      path /var/log/fluentd/buffer/openappsec_fqdn
      timekey 1d
      timekey_wait 10m
      timekey_use_utc true
      flush_interval 5s
      flush_at_shutdown true
    </buffer>
  </match>
</label>

# Nginxエラーログ処理設定
# Task 5.3: ログ転送機能実装

<label @nginx_error_process>
  # メタデータを追加（ホスト名、顧客名、FQDN名、年、月、日、時間を含む）
  # タグは変更せず、詳細情報はレコードに含める
  # labelで既にフィルタリングされているため、タグパターンは不要
  <filter **>
    @type record_transformer
    enable_ruby true
    <record>
      # メタデータをレコードに追加
      log_type "nginx"
      hostname "#{ENV['HOSTNAME'] || Socket.gethostname}"
      # 注意: Nginxエラーログにはcustomer_nameが含まれていないため、
      # 環境変数ENV["CUSTOMER_NAME"]またはデフォルト値"default"にフォールバックします
      # これにより、エラーが発生したリクエスト固有の顧客名を特定できなくなります
      # 将来的に、FQDNと顧客名をマッピングする仕組みを導入することを検討してください
      customer_name ${record["customer_name"] || ENV["CUSTOMER_NAME"] || "default"}
      # FQDNはファイルパスから抽出（/var/log/nginx/{FQDN}/error.logの形式）
      # フォールバック: レコードのfqdn、host、hostnameフィールドから取得
      fqdn ${(record["source_path"] && File.dirname(record["source_path"]).split('/').last) || record["fqdn"] || record["host"] || record["hostname"] || "unknown"}
      year ${Time.at(time).strftime("%Y")}
      month ${Time.at(time).strftime("%m")}
      day ${Time.at(time).strftime("%d")}
      hour ${Time.at(time).strftime("%H")}
      minute ${Time.at(time).strftime("%M")}
      second ${Time.at(time).strftime("%S")}
    </record>
  </filter>

  # 処理後、転送とアーカイブの両方にルーティング（labelを使用）
  # labelで既にフィルタリングされているため、タグパターンは不要
  <match **>
    @type copy
    <store>
      @type relabel
      @label @forwarder
    </store>
    <store>
      @type relabel
      @label @archive_stdout
    </store>
  </match>
</label>

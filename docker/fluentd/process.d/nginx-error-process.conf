# Nginxエラーログ処理設定
# Task 5.3: ログ転送機能実装

<label @nginx_error_process>
  # メタデータを追加（ホスト名、顧客名、FQDN名、年、月、日、時間を含む）
  <filter nginx.error.**>
    @type record_transformer
    enable_ruby true
    <record>
      # メタデータをレコードに追加
      log_type "nginx"
      hostname "#{ENV['HOSTNAME'] || Socket.gethostname}"
      # 注意: Nginxエラーログにはcustomer_nameが含まれていないため、
      # 環境変数ENV["CUSTOMER_NAME"]またはデフォルト値"default"にフォールバックします
      # これにより、エラーが発生したリクエスト固有の顧客名を特定できなくなります
      # 将来的に、FQDNと顧客名をマッピングする仕組みを導入することを検討してください
      customer_name ${record["customer_name"] || ENV["CUSTOMER_NAME"] || "default"}
      fqdn ${tag_parts[2]}
      year ${Time.at(time).strftime("%Y")}
      month ${Time.at(time).strftime("%m")}
      day ${Time.at(time).strftime("%d")}
      hour ${Time.at(time).strftime("%H")}
      minute ${Time.at(time).strftime("%M")}
      second ${Time.at(time).strftime("%S")}
    </record>
  </filter>

  # タグを完全な形式に変換（ホスト名、顧客名、FQDN名、年、月、日、時間を含む）
  <match nginx.error.**>
    @type rewrite_tag_filter
    <rule>
      key hostname
      pattern /.+/
      tag nginx.error.${record['hostname']}.${record['customer_name']}.${record['fqdn']}.${record['year']}.${record['month']}.${record['day']}.${record['hour']}
    </rule>
  </match>

  # 処理後、転送とアーカイブの両方にルーティング
  # 注意: copyプラグイン内で@labelを使用することはできないため、
  # タグを変更してルーティングする
  <match nginx.error.**>
    @type copy
    <store>
      @type rewrite_tag_filter
      <rule>
        key _
        pattern /.*/
        tag forwarder.${tag}
      </rule>
    </store>
    <store>
      @type rewrite_tag_filter
      <rule>
        key _
        pattern /.*/
        tag archive.${tag}
      </rule>
    </store>
  </match>
</label>

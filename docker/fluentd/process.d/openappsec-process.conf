# OpenAppSecログ処理設定
# Task 5.3: ログ転送機能実装

<label @openappsec_process>
  # FQDN別にタグを付け直す（中間ステップ）
  <match openappsec.detection>
    @type rewrite_tag_filter
    <rule>
      key host
      pattern /^(.+)$/
      tag openappsec.detection.${1}
    </rule>
    # hostフィールドがない場合のフォールバック
    <rule>
      key hostname
      pattern /^(.+)$/
      tag openappsec.detection.${1}
    </rule>
    # requestHostフィールドのフォールバック
    <rule>
      key requestHost
      pattern /^(.+)$/
      tag openappsec.detection.${1}
    </rule>
    # デフォルトタグ（FQDNが取得できない場合）
    <rule>
      key _
      pattern /.*/
      tag openappsec.detection.unknown
    </rule>
  </match>

  # メタデータを追加（ホスト名、顧客名、FQDN名、signature、protectionName、ruleName、年、月、日、時間を含む）
  <filter openappsec.detection.**>
    @type record_transformer
    enable_ruby true
    <record>
      # メタデータをレコードに追加
      log_type "openappsec"
      source "waf-engine"
      # タグからFQDNを抽出（タグ形式: openappsec.detection.{fqdn}）
      fqdn ${tag_parts[2]}
      # ホスト名（環境変数またはコンテナ名から取得）
      hostname "#{ENV['HOSTNAME'] || Socket.gethostname}"
      # 注意: OpenAppSecの検知ログにはcustomer_nameが含まれていないため、
      # 環境変数ENV["CUSTOMER_NAME"]またはデフォルト値"default"にフォールバックします
      # これにより、WAFイベントをリクエスト固有の顧客名と正確に関連付けることが難しくなります
      # 将来的に、FQDNと顧客名をマッピングする仕組みを導入することを検討してください
      customer_name ${record["customer_name"] || ENV["CUSTOMER_NAME"] || "default"}
      # シグニチャ情報（OpenAppSecログから抽出）
      signature ${(record["signature"] || "unknown").downcase.gsub(/[^a-z0-9_-]/, "_")}
      protection_name ${(record["protectionName"] || "unknown").downcase.gsub(/[^a-z0-9_-]/, "_")}
      rule_name ${(record["ruleName"] || "unknown").downcase.gsub(/[^a-z0-9_-]/, "_")}
      # 日時情報を抽出（timeフィールドから）
      year ${Time.at(time).strftime("%Y")}
      month ${Time.at(time).strftime("%m")}
      day ${Time.at(time).strftime("%d")}
      hour ${Time.at(time).strftime("%H")}
      minute ${Time.at(time).strftime("%M")}
      second ${Time.at(time).strftime("%S")}
    </record>
  </filter>

  # タグを完全な形式に変換（ホスト名、顧客名、FQDN名、signature、protectionName、ruleName、年、月、日、時間を含む）
  <match openappsec.detection.**>
    @type rewrite_tag_filter
    <rule>
      key hostname
      pattern /.+/
      tag openappsec.detection.${record['hostname']}.${record['customer_name']}.${record['fqdn']}.${record['signature']}.${record['protection_name']}.${record['rule_name']}.${record['year']}.${record['month']}.${record['day']}.${record['hour']}
    </rule>
  </match>

  # 処理後、転送とアーカイブの両方にルーティング
  # 注意: copyプラグイン内で@labelを使用することはできないため、
  # タグを変更してルーティングする
  <match openappsec.detection.**>
    @type copy
    <store>
      @type rewrite_tag_filter
      <rule>
        key _
        pattern /.*/
        tag forwarder.${tag}
      </rule>
    </store>
    <store>
      @type rewrite_tag_filter
      <rule>
        key _
        pattern /.*/
        tag archive.${tag}
      </rule>
    </store>
  </match>
</label>

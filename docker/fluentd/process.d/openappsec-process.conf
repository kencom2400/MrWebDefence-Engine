# OpenAppSecログ処理設定
# Task 5.3: ログ転送機能実装

<label @openappsec_process>
  # メタデータを追加（ホスト名、顧客名、FQDN名、signature、protectionName、ruleName、年、月、日、時間を含む）
  # labelで既にフィルタリングされているため、タグパターンは不要
  <filter **>
    @type record_transformer
    enable_ruby true
    <record>
      # メタデータをレコードに追加
      log_type "openappsec"
      source "waf-engine"
      # FQDNを抽出（複数のフィールドからフォールバック）
      fqdn ${record["host"] || record["hostname"] || record["requestHost"] || "unknown"}
      # ホスト名（環境変数またはコンテナ名から取得）
      hostname "#{ENV['HOSTNAME'] || Socket.gethostname}"
      # 注意: OpenAppSecの検知ログにはcustomer_nameが含まれていないため、
      # 環境変数ENV["CUSTOMER_NAME"]またはデフォルト値"default"にフォールバックします
      # これにより、WAFイベントをリクエスト固有の顧客名と正確に関連付けることが難しくなります
      # 将来的に、FQDNと顧客名をマッピングする仕組みを導入することを検討してください
      customer_name ${record["customer_name"] || ENV["CUSTOMER_NAME"] || "default"}
      # シグニチャ情報（OpenAppSecログから抽出）
      signature ${(record["signature"] || "unknown").downcase.gsub(/[^a-z0-9_-]/, "_")}
      protection_name ${(record["protectionName"] || "unknown").downcase.gsub(/[^a-z0-9_-]/, "_")}
      rule_name ${(record["ruleName"] || "unknown").downcase.gsub(/[^a-z0-9_-]/, "_")}
      # 日時情報を抽出（timeフィールドから）
      year ${Time.at(time).strftime("%Y")}
      month ${Time.at(time).strftime("%m")}
      day ${Time.at(time).strftime("%d")}
      hour ${Time.at(time).strftime("%H")}
      minute ${Time.at(time).strftime("%M")}
      second ${Time.at(time).strftime("%S")}
    </record>
  </filter>

  # タグは変更しない（シンプルなタグ: openappsec.detection）
  # 詳細情報（hostname、customer_name、fqdn等）はレコードに含まれている

  # 処理後、転送とアーカイブの両方にルーティング（labelを使用）
  # labelで既にフィルタリングされているため、タグパターンは不要
  # OpenAppSecログは、stdout出力とFQDN別ファイル出力の両方にルーティング
  <match **>
    @type copy
    <store>
      @type relabel
      @label @forwarder
    </store>
    <store>
      @type relabel
      @label @archive_stdout
    </store>
    <store>
      @type relabel
      @label @archive_openappsec_fqdn
    </store>
  </match>
</label>

# Nginxアクセスログ処理設定
# Task 5.3: ログ転送機能実装

<label @nginx_access_process>
  # メタデータを追加（ホスト名、顧客名、FQDN名、年、月、日、時間を含む）
  # labelで既にフィルタリングされているため、タグパターンは不要
  <filter **>
    @type record_transformer
    enable_ruby true
    <record>
      # メタデータをレコードに追加
      log_type "nginx"
      hostname "#{ENV['HOSTNAME'] || Socket.gethostname}"
      customer_name ${record["customer_name"] || ENV["CUSTOMER_NAME"] || "default"}
      fqdn ${tag_parts[2]}
      year ${Time.at(time).strftime("%Y")}
      month ${Time.at(time).strftime("%m")}
      day ${Time.at(time).strftime("%d")}
      hour ${Time.at(time).strftime("%H")}
      minute ${Time.at(time).strftime("%M")}
      second ${Time.at(time).strftime("%S")}
    </record>
  </filter>

  # タグを完全な形式に書き換え（ホスト名、顧客名、FQDN名、年、月、日、時間を含む）
  # labelで既にフィルタリングされているため、タグパターンは不要
  <match **>
    @type rewrite_tag_filter
    <rule>
      key hostname
      pattern /.+/
      tag nginx.access.${record['hostname']}.${record['customer_name']}.${record['fqdn']}.${record['year']}.${record['month']}.${record['day']}.${record['hour']}
    </rule>
  </match>

  # 処理後、転送とアーカイブの両方にルーティング（labelを使用）
  # labelで既にフィルタリングされているため、タグパターンは不要
  <match **>
    @type copy
    <store>
      @label @forwarder
    </store>
    <store>
      @label @archive_stdout
    </store>
  </match>
</label>

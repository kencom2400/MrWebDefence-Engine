apiVersion: v1beta2
policies:
  default:
    mode: "detect-learn"
    threatPreventionPractices: [threat-prevention-basic]
    accessControlPractices: [rate-limit-default]
    triggers: [log-trigger-basic]
    customResponse: "403"

  specificRules:
    - host: "test.example.com"
      mode: "detect-learn"
      threatPreventionPractices: [threat-prevention-basic]
      accessControlPractices: [rate-limit-default]
      triggers: [log-trigger-basic]
      customResponse: 403

threatPreventionPractices:
  - name: threat-prevention-basic
    practiceMode: prevent
    webAttacks:
      overrideMode: prevent
      minimumConfidence: medium

# アクセス制御プラクティス定義
# 注意: OpenAppSec Community Editionでは1つのルールのみサポートされています
# 複数のルールを定義しても、最初の1つだけが有効になります
accessControlPractices:
  - name: rate-limit-default
    practiceMode: prevent
    rateLimit:
      overrideMode: prevent
      rules:
        - uri: "/"
          limit: 100
          unit: minute
          action: prevent
          comment: "全エンドポイントのレート制限（Community Edition制限により1ルールのみ。元々は/login:10/分、/api/*:100/分を想定していたが、統合して100/分に設定）"

logTriggers:
  - name: log-trigger-basic
    accessControlLogging:
      allowEvents: false
      dropEvents: true
    appsecLogging:
      detectEvents: true
      preventEvents: true
      allWebRequests: false
    extendedLogging:
      urlPath: true
      urlQuery: true
    additionalSuspiciousEventsLogging:
      enabled: true
      minSeverity: high
      responseCode: true
    logDestination:
      cloud: false
      logToAgent: true
      stdout:
        format: json

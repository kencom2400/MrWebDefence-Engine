# OpenAppSec Attachment Moduleの読み込み
# OpenAppSec公式のNginxイメージには既にモジュールが組み込まれている
load_module /usr/lib/nginx/modules/ngx_cp_attachment_module.so;

# GeoIP2 Moduleの読み込み（TODO: カスタムビルドで追加予定）
# load_module /usr/lib/nginx/modules/ngx_http_geoip2_module.so;

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # GeoIP2データベースの読み込み（TODO: カスタムビルドで追加予定）
    # 注意: GeoIPデータベースはgeoip-updaterサービスによって自動更新されます
    # geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
    #     # 国コード（ISO 3166-1 alpha-2）
    #     $geoip2_data_country_iso_code country iso_code;
    #     # 国名（英語）
    #     $geoip2_data_country_name country names en;
    #     # 大陸コード
    #     $geoip2_data_continent_code continent code;
    # }

    # FQDN別GeoIP設定を読み込み（ConfigAgentが動的生成）
    # TODO: GeoIP2モジュールが統合されるまでコメントアウト
    # include /etc/nginx/geoip/*.conf;

    # OpenAppSec共有メモリゾーンの設定
    # 注意: 公式ドキュメントではOSレベルの/dev/shmを使用するため、
    # このディレクティブは実際には不要かもしれませんが、設計書（MWD-38-openappsec-integration.md）に従って追加
    # 実際の動作確認で必要に応じて調整してください
    # 設計書では以下のディレクティブが定義されていますが、公式ドキュメントでは不要の可能性があります：
    # - openappsec_shared_memory_zone zone=openappsec_shm:10m;
    # - openappsec_agent_url http://openappsec-agent:8080;
    # - openappsec_enabled on;
    # 現在の実装では、モジュールの読み込み（load_module）のみで動作確認済みです。
    # 必要に応じて、これらのディレクティブを有効化してください。
    # openappsec_shared_memory_zone zone=openappsec_shm:10m;

    # ログ設定
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # JSON形式のログフォーマット
    # 注意: customer_nameはConfigAgentが設定ファイル生成時に追加する変数（$customer_name）を使用
    log_format json_combined escape=json
      '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"http_x_forwarded_for":"$http_x_forwarded_for",'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"host":"$host",'
        '"customer_name":"$customer_name"'
      '}';

    # デフォルトのアクセスログ（JSON形式）
    access_log /var/log/nginx/access.log json_combined;

    # 基本設定
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # OpenAppSec設定
    # 注意: 公式ドキュメントではこれらのディレクティブは不要かもしれませんが、
    # 設計書（MWD-38-openappsec-integration.md）では以下のディレクティブが定義されています：
    # - openappsec_agent_url http://openappsec-agent:8080;
    # - openappsec_enabled on;
    # 現在の実装では、モジュールの読み込み（load_module）のみで動作確認済みです。
    # 必要に応じて、これらのディレクティブを有効化してください。
    # openappsec_agent_url http://openappsec-agent:8080;
    # openappsec_enabled on;
    # 詳細な設定は local_policy.yaml で行う

    # SSL/TLS設定
    # セッションキャッシュ（shared:SSL:10m = 10MBの共有キャッシュ、約40,000セッション）
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # SSL/TLSプロトコル（TLS 1.2以上を使用）
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # SSL暗号スイート（Mozillaの推奨設定）
    # ECDHE: 前方秘匿性を提供
    # GCM: 認証付き暗号化モード
    # CHACHA20-POLY1305: モバイルデバイス向けの高速暗号
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    
    # サーバー側の暗号スイート優先（TLS 1.2以下）
    # TLS 1.3では自動的にクライアント優先になる
    ssl_prefer_server_ciphers off;
    
    # SSLセッションチケット（デフォルト: on）
    # 前方秘匿性を完全に保証する場合は off にすることを検討
    ssl_session_tickets on;

    # Gzip圧縮
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

    # 設定ファイルの読み込み（FQDN別設定は自動生成される）
    include /etc/nginx/conf.d/*.conf;
}

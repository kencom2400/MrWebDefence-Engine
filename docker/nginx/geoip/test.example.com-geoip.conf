# GeoIP設定: test.example.com
# 自動生成: 2026-02-03 08:23:29
# このファイルはhttpコンテキストにincludeされます

# X-Forwarded-Forヘッダー処理（信頼できるプロキシ設定）
set_real_ip_from 192.168.0.0/16;
real_ip_header X-Forwarded-For;
real_ip_recursive on;

# IP/CIDR AllowList判定
geo $test_example_com_ip_allowed {
    default 0;
    192.168.1.0/24 1;
}

# IP/CIDR BlockList判定
geo $test_example_com_ip_blocked {
    default 0;
    198.51.100.0/24 1;
}

# 国コード AllowList判定
map $geoip2_data_country_iso_code $test_example_com_country_allowed {
    default 0;
    JP 1;
    US 1;
}

# 国コード BlockList判定
map $geoip2_data_country_iso_code $test_example_com_country_blocked {
    default 0;
    KP 1;
    RU 1;
}

# 最終的なアクセス許可判定（AllowList優先ロジック - アプローチ2）
map "$test_example_com_ip_allowed:$test_example_com_ip_blocked:$test_example_com_country_allowed:$test_example_com_country_blocked" $test_example_com_access_denied {
    # IP AllowList優先: 即座に許可
    "1:0:0:0" 0;  # IP AllowList のみ一致
    "1:1:0:0" 0;  # IP AllowList + IP BlockList → AllowList優先
    "1:0:1:0" 0;  # IP AllowList + 国コード AllowList
    "1:0:0:1" 0;  # IP AllowList + 国コード BlockList → AllowList優先
    "1:1:1:0" 0;  # IP AllowList + その他 → AllowList優先
    "1:1:0:1" 0;  # IP AllowList + その他 → AllowList優先
    "1:0:1:1" 0;  # IP AllowList + その他 → AllowList優先
    "1:1:1:1" 0;  # すべて一致 → AllowList優先
    
    # IP BlockList: 拒否（AllowListがない場合のみ）
    "0:1:0:0" 1;  # IP BlockList のみ一致
    "0:1:1:0" 1;  # IP BlockList + 国コード AllowList → BlockList優先
    "0:1:0:1" 1;  # IP BlockList + 国コード BlockList
    "0:1:1:1" 1;  # IP BlockList + 国コード両方
    
    # 国コード AllowList: 許可（IP判定なし）
    "0:0:1:0" 0;  # 国コード AllowList のみ一致
    "0:0:1:1" 0;  # 国コード両方 → AllowList優先
    
    # 国コード BlockList: 拒否（AllowListがない場合のみ）
    "0:0:0:1" 1;  # 国コード BlockList のみ一致
    
    # デフォルト: どのリストにも一致しない場合
    # AllowListが存在する場合は拒否（ホワイトリストモード）、BlockListのみの場合は許可（ブラックリストモード）
    default 1;
}
